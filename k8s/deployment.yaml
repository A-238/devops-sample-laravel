apiVersion: apps/v1
kind: Deployment
metadata:
  name: laravel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: laravel
  template:
    metadata:
      labels:
        app: laravel
    spec:
      volumes:
      - name: laravel-data
        emptyDir: {}
      initContainers:
      - name: copy-laravel
        image: agafumiya/laravel-demo:latest
        command:
        - sh
        - -c
        - |
          cp -r /var/www/laravel/. /shared
          chown -R www-data:www-data /shared/storage /shared/bootstrap/cache
          chmod -R ug+rwx /shared/storage /shared/bootstrap/cache
          mkdir -p /shared/database
          [ -f /shared/database/database.sqlite ] || touch /shared/database/database.sqlite
          chown -R www-data:www-data /shared/database
          chmod -R ug+rwx /shared/database
        volumeMounts:
        - name: laravel-data
          mountPath: /shared
      containers:
      - name: laravel
        image: agafumiya/laravel-demo:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 9000
        volumeMounts:
        - name: laravel-data
          mountPath: /var/www/laravel
        env:
        - name: APP_ENV
          value: production
      - name: nginx
        image: agafumiya/laravel-demo-nginx:v0.1.3
        imagePullPolicy: Always
        ports:
        - containerPort: 80
        volumeMounts:
        - name: laravel-data
          mountPath: /var/www/laravel
        env:
        - name: APP_ENV
          value: production